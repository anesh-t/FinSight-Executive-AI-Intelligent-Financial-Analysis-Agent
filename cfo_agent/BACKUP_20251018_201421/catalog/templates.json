{
  "templates": {
    "quarter_snapshot": {
      "intent": "quarter_snapshot",
      "surface": "fact_financials, vw_ratios_quarter",
      "description": "Get quarterly metrics including revenue, income, expenses (R&D, SG&A, COGS), and ALL ratios (margins, ROE, ROA, debt ratios, intensity ratios). Use for all quarterly queries like 'Q2 2023 revenue', 'Q2 2023 ROE', 'Q2 2023 debt to equity', 'Q3 2023 R&D intensity', 'latest quarter margins'.",
      "sql": "SELECT c.ticker, c.name, f.fiscal_year, f.fiscal_quarter, f.revenue/1e9 as revenue_b, f.net_income/1e9 as net_income_b, f.operating_income/1e9 as op_income_b, f.gross_profit/1e9 as gross_profit_b, f.r_and_d_expenses/1e9 as rd_b, f.sg_and_a_expenses/1e9 as sga_b, f.cogs/1e9 as cogs_b, f.cash_flow_ops/1e9 as operating_cash_flow, f.cash_flow_investing/1e9 as investing_cash_flow, f.cash_flow_financing/1e9 as financing_cash_flow, f.capex/1e9 as capex, f.dividends/1e9 as dividends, f.buybacks/1e9 as buybacks, f.eps, f.total_assets, f.total_liabilities, f.equity, r.gross_margin, r.operating_margin, r.net_margin, r.roe, r.roa, r.debt_to_equity, r.debt_to_assets, r.rnd_to_revenue, r.sgna_to_revenue FROM fact_financials f JOIN dim_company c USING (company_id) LEFT JOIN vw_ratios_quarter r ON r.company_id = f.company_id AND r.fiscal_year = f.fiscal_year AND r.fiscal_quarter = f.fiscal_quarter WHERE c.ticker = :ticker AND (CAST(:fy AS INTEGER) IS NULL OR f.fiscal_year = :fy) AND (CAST(:fq AS INTEGER) IS NULL OR f.fiscal_quarter = :fq) ORDER BY f.fiscal_year DESC, f.fiscal_quarter DESC LIMIT :limit",
      "params": ["ticker", "fy", "fq", "limit"],
      "default_params": {"limit": 1, "fy": null, "fq": null}
    },
    "annual_metrics": {
      "intent": "annual_metrics",
      "surface": "mv_financials_annual, mv_ratios_annual, fact_financials",
      "description": "Get annual financial metrics including revenue, income, expenses (R&D, SG&A, COGS), cash flows, EPS, and ratios for a specific year. Use for queries like 'Apple revenue 2023', 'R&D expenses for 2023', 'SG&A 2023', 'annual metrics', 'EPS 2023'.",
      "sql": "SELECT c.ticker, c.name, mv.fiscal_year, mv.revenue_annual/1e9 as revenue_b, mv.net_income_annual/1e9 as net_income_b, mv.operating_income_annual/1e9 as op_income_b, mv.gross_profit_annual/1e9 as gross_profit_annual_b, mv.r_and_d_expenses_annual/1e9 as rd_annual_b, mv.sg_and_a_expenses_annual/1e9 as sga_annual_b, mv.cogs_annual/1e9 as cogs_annual_b, mv.total_assets_eoy, mv.total_liabilities_eoy, mv.equity_eoy, mv.cash_flow_ops_annual/1e9 as operating_cash_flow, mv.cash_flow_investing_annual/1e9 as investing_cash_flow, mv.cash_flow_financing_annual/1e9 as financing_cash_flow, mv.capex_annual/1e9 as capex_annual_b, SUM(f.eps) as eps, SUM(f.dividends)/1e9 as dividends, SUM(f.buybacks)/1e9 as buybacks, r.gross_margin_annual, r.operating_margin_annual, r.net_margin_annual, r.roe_annual_avg_equity, r.roa_annual, r.debt_to_assets_annual, r.debt_to_equity_annual, r.rnd_to_revenue_annual, r.sgna_to_revenue_annual FROM mv_financials_annual mv JOIN mv_ratios_annual r USING (company_id, fiscal_year) JOIN dim_company c USING (company_id) LEFT JOIN fact_financials f ON f.company_id = mv.company_id AND f.fiscal_year = mv.fiscal_year WHERE c.ticker = :ticker AND (CAST(:fy AS INTEGER) IS NULL OR mv.fiscal_year = :fy) GROUP BY c.ticker, c.name, mv.fiscal_year, mv.revenue_annual, mv.net_income_annual, mv.operating_income_annual, mv.gross_profit_annual, mv.r_and_d_expenses_annual, mv.sg_and_a_expenses_annual, mv.cogs_annual, mv.total_assets_eoy, mv.total_liabilities_eoy, mv.equity_eoy, mv.cash_flow_ops_annual, mv.cash_flow_investing_annual, mv.cash_flow_financing_annual, mv.capex_annual, r.gross_margin_annual, r.operating_margin_annual, r.net_margin_annual, r.roe_annual_avg_equity, r.roa_annual, r.debt_to_assets_annual, r.debt_to_equity_annual, r.rnd_to_revenue_annual, r.sgna_to_revenue_annual ORDER BY mv.fiscal_year DESC LIMIT :limit",
      "params": ["ticker", "fy", "limit"],
      "default_params": {"limit": 1, "fy": null}
    },
    "growth_qoq_yoy": {
      "intent": "growth_qoq_yoy",
      "surface": "vw_growth_quarter",
      "description": "Get quarter-over-quarter and year-over-year growth rates",
      "sql": "SELECT c.ticker, c.name, g.fiscal_year, g.fiscal_quarter, g.revenue_qoq, g.revenue_yoy, g.net_income_qoq, g.net_income_yoy FROM vw_growth_quarter g JOIN dim_company c USING (company_id) WHERE c.ticker = :ticker AND (CAST(:fy AS INTEGER) IS NULL OR g.fiscal_year = :fy) AND (CAST(:fq AS INTEGER) IS NULL OR g.fiscal_quarter = :fq) ORDER BY g.fiscal_year DESC, g.fiscal_quarter DESC LIMIT :limit",
      "params": ["ticker", "fy", "fq", "limit"],
      "default_params": {"limit": 4, "fy": null, "fq": null}
    },
    "growth_annual_cagr": {
      "intent": "growth_annual_cagr",
      "surface": "vw_growth_annual",
      "description": "Get annual growth rates and CAGR (3-year, 5-year)",
      "sql": "SELECT c.ticker, c.name, g.fiscal_year, g.revenue_yoy, g.revenue_cagr_3y, g.revenue_cagr_5y, g.net_income_yoy FROM vw_growth_annual g JOIN dim_company c USING (company_id) WHERE c.ticker = :ticker AND (CAST(:fy AS INTEGER) IS NULL OR g.fiscal_year = :fy) ORDER BY g.fiscal_year DESC LIMIT :limit",
      "params": ["ticker", "fy", "limit"],
      "default_params": {"limit": 1, "fy": null}
    },
    "peer_leaderboard_quarter": {
      "intent": "peer_leaderboard_quarter",
      "surface": "vw_peer_stats_quarter",
      "description": "Get peer rankings and percentiles for quarterly metrics",
      "sql": "SELECT p.company_id, c.ticker, p.fiscal_year, p.fiscal_quarter, p.revenue/1e9 as revenue_b, p.net_margin, p.roe, p.rank_revenue, p.rank_net_margin, p.rank_roe, p.pct_revenue, p.pct_net_margin, p.pct_roe FROM vw_peer_stats_quarter p JOIN dim_company c USING (company_id) ORDER BY p.fiscal_year DESC, p.fiscal_quarter DESC, p.rank_net_margin LIMIT :limit",
      "params": ["limit"],
      "default_params": {"limit": 5}
    },
    "peer_leaderboard_annual": {
      "intent": "peer_leaderboard_annual",
      "surface": "vw_peer_stats_annual",
      "description": "Get peer rankings and percentiles for annual metrics",
      "sql": "SELECT p.company_id, c.ticker, p.fiscal_year, p.revenue_annual/1e9 as revenue_b, p.net_margin_annual, p.operating_margin_annual, p.roe_annual_avg_equity, p.rank_revenue_annual, p.pct_revenue_annual, p.z_revenue_annual FROM vw_peer_stats_annual p JOIN dim_company c USING (company_id) WHERE (CAST(:fy AS INTEGER) IS NULL OR p.fiscal_year = :fy) ORDER BY p.fiscal_year DESC, p.operating_margin_annual DESC LIMIT :limit",
      "params": ["fy", "limit"],
      "default_params": {"limit": 5, "fy": null}
    },
    "macro_values_quarter": {
      "intent": "macro_values_quarter",
      "surface": "vw_company_quarter_macro",
      "description": "Get company metrics with macro indicator values for a quarter",
      "sql": "SELECT c.ticker, c.name, m.fiscal_year, m.fiscal_quarter, m.revenue/1e9 as revenue_b, m.net_margin, m.cpi, m.fed_funds_rate, m.sp500_index, m.unemployment_rate FROM vw_company_quarter_macro m JOIN dim_company c USING (company_id) WHERE c.ticker = :ticker AND (CAST(:fy AS INTEGER) IS NULL OR m.fiscal_year = :fy) AND (CAST(:fq AS INTEGER) IS NULL OR m.fiscal_quarter = :fq) ORDER BY m.fiscal_year DESC, m.fiscal_quarter DESC LIMIT :limit",
      "params": ["ticker", "fy", "fq", "limit"],
      "default_params": {"limit": 1, "fy": null, "fq": null}
    },
    "macro_betas_rolling": {
      "intent": "macro_betas_rolling",
      "surface": "vw_macro_sensitivity_rolling",
      "description": "Get rolling macro sensitivities (betas) over 12 quarters",
      "sql": "SELECT c.ticker, c.name, s.fiscal_year, s.fiscal_quarter, s.beta_nm_cpi_12q, s.beta_nm_ffr_12q, s.beta_nm_spx_12q FROM vw_macro_sensitivity_rolling s JOIN dim_company c USING (company_id) WHERE c.ticker = :ticker AND (CAST(:fy AS INTEGER) IS NULL OR s.fiscal_year = :fy) AND (CAST(:fq AS INTEGER) IS NULL OR s.fiscal_quarter = :fq) ORDER BY s.fiscal_year DESC, s.fiscal_quarter DESC LIMIT :limit",
      "params": ["ticker", "fy", "fq", "limit"],
      "default_params": {"limit": 1, "fy": null, "fq": null}
    },
    "health_flags": {
      "intent": "health_flags",
      "surface": "vw_financial_health_quarter",
      "description": "Get balance sheet health flags and validation",
      "sql": "SELECT c.ticker, c.name, h.fiscal_year, h.fiscal_quarter, h.balance_status, h.balance_gap_pct, h.flag_negative_equity, h.flag_net_loss FROM vw_financial_health_quarter h JOIN dim_company c USING (company_id) WHERE c.ticker = :ticker AND (CAST(:fy AS INTEGER) IS NULL OR h.fiscal_year = :fy) AND (CAST(:fq AS INTEGER) IS NULL OR h.fiscal_quarter = :fq) ORDER BY h.fiscal_year DESC, h.fiscal_quarter DESC LIMIT :limit",
      "params": ["ticker", "fy", "fq", "limit"],
      "default_params": {"limit": 1, "fy": null, "fq": null}
    },
    "outliers": {
      "intent": "outliers",
      "surface": "vw_outliers_quarter",
      "description": "Detect 3-sigma outliers in revenue and margins",
      "sql": "SELECT o.company_id, c.ticker, o.fiscal_year, o.fiscal_quarter, o.z_revenue, o.z_net_margin, o.outlier_revenue_3sigma, o.outlier_net_margin_3sigma FROM vw_outliers_quarter o JOIN dim_company c USING (company_id) WHERE c.ticker = :ticker AND (o.outlier_revenue_3sigma = 1 OR o.outlier_net_margin_3sigma = 1) ORDER BY o.fiscal_year DESC, o.fiscal_quarter DESC LIMIT :limit",
      "params": ["ticker", "limit"],
      "default_params": {"limit": 10}
    },
    "annual_revenue_single_year": {
      "intent": "annual_revenue_single_year",
      "surface": "mv_financials_annual",
      "description": "Get annual revenue for a single company and year",
      "sql": "SELECT f.company_id, c.ticker, c.name, f.fiscal_year, f.revenue_annual/1e9 as revenue_b FROM mv_financials_annual f JOIN dim_company c USING (company_id) WHERE c.ticker = :ticker AND f.fiscal_year = :fy LIMIT 1",
      "params": ["ticker", "fy"],
      "default_params": {}
    },
    "compare_ratio_annual_two": {
      "intent": "compare_ratio_annual_two",
      "surface": "mv_ratios_annual",
      "description": "Compare a ratio (e.g., ROE) between two companies for a year",
      "sql": "SELECT r.company_id, c.ticker, c.name, r.fiscal_year, r.roe_annual_avg_equity, r.roa_annual, r.gross_margin_annual, r.operating_margin_annual, r.net_margin_annual FROM mv_ratios_annual r JOIN dim_company c USING (company_id) WHERE c.ticker IN (:t1, :t2) AND r.fiscal_year = :fy ORDER BY c.ticker LIMIT 2",
      "params": ["t1", "t2", "fy"],
      "default_params": {}
    },
    "narrative_brief_latest": {
      "intent": "narrative_brief_latest",
      "surface": "vw_cfo_answers",
      "description": "Get latest quarter comprehensive snapshot for narrative",
      "sql": "SELECT company_id, ticker, name, fyq_label, revenue/1e9 as revenue_b, net_income/1e9 as net_income_b, gross_margin, net_margin, roe, revenue_qoq, revenue_yoy, net_income_ttm/1e9 as net_income_ttm_b, rank_revenue, rank_net_margin, pct_net_margin, gross_profit_source FROM vw_cfo_answers WHERE ticker = :ticker ORDER BY fiscal_year DESC, fiscal_quarter DESC LIMIT 1",
      "params": ["ticker"],
      "default_params": {}
    }
  }
}
